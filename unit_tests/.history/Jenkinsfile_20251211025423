pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.11'
        ALLURE_VERSION = '2.24.0'
    }
    
    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Клонування репозиторію..."
                    checkout scm
                }
            }
        }
        
        stage('Setup Python Environment') {
            steps {
                script {
                    echo "Налаштування Python віртуального середовища..."
                    bat '''
                        python --version
                        python -m venv venv
                        call venv\\Scripts\\activate.bat
                        python -m pip install --upgrade pip
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    echo "Встановлення залежностей..."
                    bat '''
                        call venv\\Scripts\\activate.bat
                        pip install -r requirements.txt
                        pip list
                    '''
                }
            }
        }
        
        stage('Run Linting') {
            steps {
                script {
                    echo "Запуск лінтера коду..."
                    bat '''
                        call venv\\Scripts\\activate.bat
                        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || exit 0
                        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
                    '''
                }
            }
        }
        
        stage('Run Unit Tests (Parallel)') {
            steps {
                script {
                    echo "Запуск тестів з паралелізацією..."
                    bat '''
                        call venv\\Scripts\\activate.bat
                        pytest tests/ -n auto --maxprocesses=4 ^
                            --alluredir=allure-results ^
                            --junitxml=reports/junit.xml ^
                            --html=reports/report.html ^
                            --self-contained-html ^
                            -v --tb=short
                    '''
                }
            }
        }
        
        stage('Run BDD Tests') {
            steps {
                script {
                    echo "Запуск BDD тестів..."
                    bat '''
                        call venv\\Scripts\\activate.bat
                        pytest tests/bdd/ --alluredir=allure-results -v || exit 0
                    '''
                }
            }
        }
        
        stage('Generate Coverage Report') {
            steps {
                script {
                    echo "Генерація звіту покриття коду..."
                    bat '''
                        call venv\\Scripts\\activate.bat
                        pytest tests/ --cov=. --cov-report=html:reports/coverage ^
                            --cov-report=xml:reports/coverage.xml ^
                            --cov-report=term
                    '''
                }
            }
        }
        
        stage('Generate Allure Report') {
            steps {
                script {
                    echo "Генерація Allure звіту..."
                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'allure-results']]
                    ])
                }
            }
        }
    }
    
    post {
        always {
            echo "Збереження артефактів та звітів..."
            
            // Публікація JUnit тестових результатів
            junit allowEmptyResults: true, testResults: 'reports/junit.xml'
            
            // Публікація HTML звіту
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'report.html',
                reportName: 'Pytest HTML Report'
            ])
            
            // Публікація Coverage звіту
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports/coverage',
                reportFiles: 'index.html',
                reportName: 'Coverage Report'
            ])
            
            // Архівування артефактів
            archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-results/**/*', allowEmptyArchive: true
            
            // Очищення віртуального середовища
            bat 'if exist venv rmdir /s /q venv'
        }
        
        success {
            echo "✅ Build успішний! Всі тести пройшли."
        }
        
        failure {
            echo "❌ Build провалився! Перевірте логи та звіти."
        }
        
        unstable {
            echo "⚠️ Build нестабільний. Деякі тести не пройшли."
        }
    }
}
