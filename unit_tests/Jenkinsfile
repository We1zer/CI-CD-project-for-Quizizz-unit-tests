pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3.9'
        VENV_DIR = 'venv'
        ALLURE_VERSION = '2.24.0'
    }
    
    options {
        // –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 10 –∑–±—ñ—Ä–æ–∫
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // –¢–∞–π–º–∞—É—Ç –¥–ª—è –≤—Å—å–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω—É
        timeout(time: 30, unit: 'MINUTES')
        // –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ timestamps –≤ –ª–æ–≥–∞—Ö
        timestamps()
    }
    
    triggers {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤ Git
        pollSCM('H/5 * * * *')
        // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–∞ –∑–±—ñ—Ä–∫–∞ –∫–æ–∂–µ–Ω –¥–µ–Ω—å –æ 2:00
        cron('0 2 * * *')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–¥—É –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é...'
                checkout scm
                script {
                    env.GIT_COMMIT_MSG = bat(returnStdout: true, script: 'git log -1 --pretty=%%B').trim()
                    env.GIT_AUTHOR = bat(returnStdout: true, script: 'git log -1 --pretty=%%an').trim()
                    echo "Commit: ${env.GIT_COMMIT_MSG}"
                    echo "Author: ${env.GIT_AUTHOR}"
                }
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Python —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞...'
                dir('unit_tests') {
                    bat '''
                        python --version
                        python -m venv %VENV_DIR%
                        call %VENV_DIR%\\Scripts\\activate.bat
                        python -m pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo 'üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π...'
                dir('unit_tests') {
                    bat '''
                        call %VENV_DIR%\\Scripts\\activate.bat
                        pip install pytest pytest-xdist pytest-html allure-pytest pytest-parallel pytest-cov
                        pip list
                    '''
                }
            }
        }
        
        stage('Code Quality Check') {
            steps {
                echo 'üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —è–∫–æ—Å—Ç—ñ –∫–æ–¥—É...'
                dir('unit_tests') {
                    bat '''
                        call %VENV_DIR%\\Scripts\\activate.bat
                        pip install pylint flake8
                        echo "=== Pylint Report ===" || exit 0
                        pylint *.py --exit-zero --output-format=text --reports=y > reports/pylint_report.txt || exit 0
                        echo "=== Flake8 Report ===" || exit 0
                        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || exit 0
                    '''
                }
            }
        }
        
        stage('Parallel Tests') {
            parallel {
                stage('Unit Tests - Sequential') {
                    steps {
                        echo 'üß™ –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç—ñ–≤ (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ)...'
                        dir('unit_tests') {
                            bat '''
                                call %VENV_DIR%\\Scripts\\activate.bat
                                pytest tests/ -v --html=reports/report_sequential.html --self-contained-html --tb=short
                            '''
                        }
                    }
                }
                
                stage('Unit Tests - Parallel') {
                    steps {
                        echo '‚ö° –ó–∞–ø—É—Å–∫ Unit —Ç–µ—Å—Ç—ñ–≤ (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ –∑ pytest-xdist)...'
                        dir('unit_tests') {
                            bat '''
                                call %VENV_DIR%\\Scripts\\activate.bat
                                pytest tests/ -n auto -v --html=reports/report_parallel.html --self-contained-html --tb=short
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Coverage Report') {
            steps {
                echo 'üìä –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–≤—ñ—Ç—É –ø–æ–∫—Ä–∏—Ç—Ç—è –∫–æ–¥—É...'
                dir('unit_tests') {
                    bat '''
                        call %VENV_DIR%\\Scripts\\activate.bat
                        pytest tests/ --cov=. --cov-report=html:reports/coverage --cov-report=xml:reports/coverage.xml --cov-report=term
                    '''
                }
            }
        }
        
        stage('Allure Report Generation') {
            steps {
                echo 'üìà –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è Allure –∑–≤—ñ—Ç—É...'
                dir('unit_tests') {
                    bat '''
                        call %VENV_DIR%\\Scripts\\activate.bat
                        pytest tests/ --alluredir=reports/allure-results -v
                    '''
                }
                script {
                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'unit_tests/reports/allure-results']]
                    ])
                }
            }
        }
        
        stage('BDD Tests') {
            when {
                expression { fileExists('unit_tests/tests/bdd/features') }
            }
            steps {
                echo 'ü•í –ó–∞–ø—É—Å–∫ BDD —Ç–µ—Å—Ç—ñ–≤ (—è–∫—â–æ —ñ—Å–Ω—É—é—Ç—å)...'
                dir('unit_tests') {
                    bat '''
                        call %VENV_DIR%\\Scripts\\activate.bat
                        pip install behave
                        behave tests/bdd/features --junit --junit-directory reports/bdd || exit 0
                    '''
                }
            }
        }
        
        stage('Archive Artifacts') {
            steps {
                echo 'üíæ –ê—Ä—Ö—ñ–≤—É–≤–∞–Ω–Ω—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤...'
                dir('unit_tests') {
                    archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: 'report_parallel.html,report_sequential.html',
                        reportName: 'Test Reports',
                        reportTitles: 'Test Reports'
                    ])
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'reports/coverage',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report',
                        reportTitles: 'Coverage Report'
                    ])
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ –û—á–∏—â–µ–Ω–Ω—è...'
            junit testResults: 'unit_tests/reports/**/*.xml', allowEmptyResults: true
        }
        
        success {
            echo '‚úÖ –ó–±—ñ—Ä–∫–∞ —É—Å–ø—ñ—à–Ω–∞!'
            script {
                if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master') {
                    echo 'üéâ –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –º–æ–∂–µ –±—É—Ç–∏ —Ç—É—Ç...'
                }
            }
        }
        
        failure {
            echo '‚ùå –ó–±—ñ—Ä–∫–∞ –Ω–µ –≤–¥–∞–ª–∞—Å—è!'
            // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (email, Slack —ñ —Ç.–¥.)
        }
        
        unstable {
            echo '‚ö†Ô∏è –ó–±—ñ—Ä–∫–∞ –Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∞ (–¥–µ—è–∫—ñ —Ç–µ—Å—Ç–∏ –Ω–µ –ø—Ä–æ–π—à–ª–∏)'
        }
    }
}
